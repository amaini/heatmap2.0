<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Stocks Heatmap</title>
  <link rel="stylesheet" href="/static/market/css/styles.css" />
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="left">
        <h1>Stocks Heatmap</h1>
        <div class="connection" id="connStatus" title="API connection status">Connecting…</div>
      </div>
      <div class="right">
        {% comment %} Auth/Admin controls {% endcomment %}
        <div class="user-actions" style="display:flex; align-items:center; gap:8px; margin-right:8px;">
          {% if user.is_authenticated %}
            <span class="muted" title="Current user">{{ user.get_username }}</span>
            {% if user.is_staff %}
              <a class="btn" href="{% url 'admin:index' %}">Admin</a>
              <a class="btn" href="/admin/auth/user/" title="Manage users">User Management</a>
            {% endif %}
            <a class="btn" href="{% url 'logout' %}?next={{ request.path }}">Logout</a>
          {% else %}
            <a class="btn btn-primary" href="{% url 'login' %}?next={{ request.path }}">Login</a>
          {% endif %}
        </div>
        <button id="btnOpenColors" class="icon-btn ghost" title="Tile colors" aria-label="Tile colors">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
            <path d="M12 3a9 9 0 0 0-9 9 9 9 0 0 0 9 9c.9 0 1.5-.3 2-.8.4-.4.6-.9.5-1.5-.1-.8-.7-1.6-1.6-1.6h-1.1c-2.2 0-4-1.8-4-4 0-3.9 3.1-7 7-7 2.8 0 5 2.2 5 5 0 1.7-1.3 3-3 3h-1"/>
          </svg>
        </button>
        <button id="btnRefresh" class="btn btn-primary">
          <span class="spinner small" id="refreshSpinner" hidden></span>
          Refresh
        </button>
        <label class="auto-refresh">
          Auto-refresh
          <select id="autoRefresh">
            <option value="off">Off</option>
            <option value="60">1 min</option>
            <option value="300">5 min</option>
            <option value="900">15 min</option>
            <option value="1800">30 min</option>
          </select>
        </label>
        <div id="nextRefresh" class="muted" title="Next auto refresh">—</div>
        <div id="lastRefresh" class="muted" title="Last refresh timestamp">—</div>
      </div>
    </header>

    <aside class="sidebar">
      <div class="sidebar-header">
        <button id="btnToggleSidebarPanel" class="icon-btn" title="Hide panel" aria-label="Hide panel">⮜</button>
      </div>
      <div class="card">
        <div class="legend">
          <div class="legend-row">
            <span class="legend-box gain"></span> Gain
            <span class="legend-box neutral"></span> Flat
            <span class="legend-box loss"></span> Loss
          </div>
        </div>
        <div class="market-status" id="marketStatus">Market: —</div>
      </div>

      <div class="card">
        <h3>Manage</h3>
        <div class="stack">
          <button class="btn" id="btnAddSector">Add Sector</button>
          <button class="btn" id="btnAddTicker">Add Ticker</button>
          <button class="btn" id="btnManageLots">Manage Lots</button>
        </div>
      </div>

      <!-- Tile Colors moved to floating dialog -->

      <div class="card">
        <h3>API Key</h3>
        <div class="stack">
          <label>Finnhub API Key
            <input id="apiKeyInput" class="input" placeholder="Enter API key" />
          </label>
          <div class="form-actions" style="justify-content: flex-start; gap:8px;">
            <button id="btnSaveApiKey" class="btn btn-primary">Save Key</button>
          </div>
          <div class="muted" id="apiKeyStatus">Not set</div>
        </div>
      </div>

      <div class="card">
        <h3>Search Ticker</h3>
        <input id="searchInput" class="input" placeholder="Search symbol or name" autocomplete="off" />
        <div id="searchResults" class="search-results" hidden></div>
      </div>
    </aside>
    <button id="sidebarHandle" class="icon-btn sidebar-handle" title="Show panel" aria-label="Show panel" hidden>⮞</button>

    <main class="content">
      <div id="heatmap" class="heatmap">
        <!-- Sector groups and tiles will be rendered here -->
      </div>
      <div id="loadingSkeleton" class="skeleton-grid" hidden></div>
      <div id="errorBox" class="error" hidden></div>
    </main>

    <!-- Modals -->
    <div class="modal" id="modalSector" hidden>
      <div class="modal-content">
        <h3 id="modalSectorTitle">Add Sector</h3>
        <form id="formSector" class="form">
          <input type="hidden" name="id" />
          <label>Sector Name
            <input name="name" class="input" required minlength="2" />
          </label>
          <div class="form-actions">
            <button type="button" class="btn" data-close>Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="modalTicker" hidden>
      <div class="modal-content">
        <h3 id="modalTickerTitle">Add Ticker</h3>
        <form id="formTicker" class="form">
          <input type="hidden" name="id" />
          <label>Symbol
            <input name="symbol" class="input" pattern="^[A-Z][A-Z0-9\.\-]{0,9}$" required />
          </label>
          <div id="symbolSuggest" class="search-results small" hidden></div>
          <label>Company Name
            <input name="company_name" class="input" />
          </label>
          <label>Sector
            <select name="sector" class="input" required id="selectSector"></select>
          </label>
          <label>Security Type
            <input name="security_type" class="input" placeholder="Common Stock" />
          </label>
          <div class="form-actions">
            <button type="button" class="btn" data-close>Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="modalLots" hidden>
      <div class="modal-content large">
        <h3>Purchased Lots</h3>
        <div class="lot-controls">
          <label>Ticker
            <select id="lotsTickerFilter" class="input"></select>
          </label>
          <button id="btnAddLot" class="btn">Add Lot</button>
        </div>
        <div id="lotsList" class="lots-list"></div>
        <div class="form-actions">
          <button type="button" class="btn" data-close>Close</button>
        </div>
      </div>
    </div>

    <div class="modal" id="modalLotForm" hidden>
      <div class="modal-content">
        <h3 id="modalLotTitle">Add Lot</h3>
        <form id="formLot" class="form">
          <input type="hidden" name="id" />
          <label>Ticker
            <select name="ticker" class="input" id="selectLotTicker" required></select>
          </label>
          <label>Quantity
            <input name="quantity" type="number" step="0.0001" min="0" class="input" required />
          </label>
          <label>Price
            <input name="price" type="number" step="0.0001" min="0" class="input" required />
          </label>
          <label>Trade Date
            <input name="trade_date" type="date" class="input" required />
          </label>
          <label>Notes
            <input name="notes" class="input" />
          </label>
          <div class="form-actions">
            <button type="button" class="btn" data-close>Cancel</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div class="modal" id="modalMoveTicker" hidden>
      <div class="modal-content">
        <h3>Move Ticker</h3>
        <form id="formMoveTicker" class="form">
          <input type="hidden" id="moveTickerId" />
          <label>Move to Sector
            <select id="selectMoveSector" class="input"></select>
          </label>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Move</button>
          </div>
        </form>
        <div class="form-actions" style="justify-content: space-between; margin-top: 8px;">
          <div class="muted">Lots</div>
          <div>
            <button type="button" id="btnMoveManageLots" class="btn">Manage Lots</button>
            <button type="button" id="btnMoveAddLot" class="btn btn-primary">Add Lot</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    window.HEATMAP_CONFIG = {
      csrftoken: (function(){
        function getCookie(name){ const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)'); return m ? m.pop() : ''; }
        return getCookie('csrftoken');
      })(),
      timeout: {{ FINNHUB_TIMEOUT_SECONDS|default:10 }},
    };
  </script>
  <!-- Copilot Bot Modal -->
  <div class="modal side" id="modalCopilot" hidden>
    <div class="modal-content copilot">
      <h3>Trading Assistant</h3>
      <div id="copilotBody" class="copilot-body">
        <div class="muted">Gathering insights…</div>
      </div>
    </div>
  </div>
  <!-- Floating Bot Button -->
  <button id="btnCopilot" class="fab-bot" title="Open Trading Assistant" aria-label="Open Trading Assistant">
    <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
      <path fill="currentColor" d="M12 2a5 5 0 00-5 5v1H6a2 2 0 00-2 2v4a6 6 0 006 6h4a6 6 0 006-6V10a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm-3 6V7a3 3 0 016 0v1H9zm1 6a1 1 0 112 0 1 1 0 01-2 0zm4 0a1 1 0 112 0 1 1 0 01-2 0z"/>
    </svg>
  </button>
  <!-- Colors modal -->
  <div class="modal" id="modalColors" hidden>
    <div class="modal-content">
      <h3>Tile Colors</h3>
      <form id="formColors" class="form">
        <label>Gain
          <input type="color" id="colorGain" class="input" value="#103b28" />
        </label>
        <label>Flat
          <input type="color" id="colorFlat" class="input" value="#1a2333" />
        </label>
        <label>Loss
          <input type="color" id="colorLoss" class="input" value="#3b1010" />
        </label>
        <div class="form-actions">
          <button type="button" class="btn" data-close>Close</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
  <script src="/static/market/js/app.js"></script>
</body>
</html>
